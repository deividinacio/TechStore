<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Produtos</h1>

    <!-- Tabela de Produtos -->
    <table id="tabela-produtos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Preço</th>
          <th>Quantidade</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        <!-- Produtos serão carregados aqui -->
      </tbody>
    </table>

    <button onclick="enviarPedido()">Fazer Pedido</button>
  </div>

  <script>
    // Armazena os itens do pedido
    const pedido = [];

    async function carregarProdutos() {
      try {
        const response = await fetch('/api/produtos');
        const produtos = await response.json();

        const tbody = document.getElementById('tabela-produtos').querySelector('tbody');
        tbody.innerHTML = '';  // Limpa a tabela antes de preencher

        produtos.forEach(produto => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${produto.idproduto}</td>
            <td>${produto.nome}</td>
            <td>R$ ${produto.preco}</td>
            <td>
              <input type="number" id="quantidade-${produto.idproduto}" min="1" value="1">
            </td>
            <td>
              <button onclick="adicionarAoPedido(${produto.idproduto}, '${produto.nome}', ${produto.preco})">Adicionar ao Pedido</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
      }
    }

    function adicionarAoPedido(id, nome, preco) {
      const quantidade = document.getElementById(`quantidade-${id}`).value;
      const item = { id, nome, preco, quantidade: parseInt(quantidade) };

      // Verifica se o produto já está no pedido e atualiza a quantidade
      const itemExistente = pedido.find(produto => produto.id === id);
      if (itemExistente) {
        itemExistente.quantidade += item.quantidade;
      } else {
        pedido.push(item);
      }

      alert(`Produto "${nome}" adicionado ao pedido com quantidade ${quantidade}.`);
    }

    async function enviarPedido() {
      if (pedido.length === 0) {
        alert('Nenhum produto foi adicionado ao pedido.');
        return;
      }

      try {
        const response = await fetch('/api/pedidos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itens: pedido })
        });

        if (response.ok) {
          alert('Pedido enviado com sucesso!');
          pedido.length = 0; // Limpa o array de pedido
          window.location.href = 'pedidos.html';
        } else {
          const errorData = await response.json();
          alert(`Erro ao enviar pedido: ${errorData.error}`);
        }
      } catch (error) {
        console.error('Erro ao enviar pedido:', error);
        alert('Erro ao enviar pedido.');
      }
    }

    document.addEventListener('DOMContentLoaded', carregarProdutos);
  </script>
</body>
</html>
